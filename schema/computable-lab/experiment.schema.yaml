$schema: "http://json-schema.org/draft-07/schema#"
$title: "Experiment"
type: object

allOf:
  - $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required:
  - title
  - protocolId
  - samples
  - projectId
  - shortSlug

properties:
  recordType:
    type: string
    description: "Record discriminator. Should be 'experiment'."
  state:
    type: string
    description: "Workflow state identifier (e.g., draft, approved)."
  recordId:
    type: string
    description: "Stable filesystem identifier generated from naming rules."
  shortSlug:
    type: string
    description: >
      Short identifier (2–4 uppercase alphanumeric chars) used in child Run IDs.
      Example: 'AB01'
    pattern: "^[A-Z0-9]{2,4}$"
    minLength: 2
    maxLength: 4

  projectId:
    type: string
    description: >
      Reference to parent Project/Investigation.
      Should match an existing project record ID.
    # Optional pattern; adjust to your naming convention
    # pattern: "^PRJ-[0-9]{4}(_[A-Z0-9_]+)?$"

  protocolId:
    type: string
    description: >
      Reference to the protocol record used for this experiment.
    # pattern: "^PR-[0-9]{4}(_[A-Z0-9_]+)?$"

  projectShortSlug:
    type: string
    description: "Short slug inherited from the parent project for path generation."

  runs:
    type: array
    description: >
      Child Run record identifiers associated with this Experiment.
    items:
      type: string
      description: "Run record ID or path (e.g., 'RUN-0001_AB01_INITIAL')."

  samples:
    type: array
    description: >
      Sample record identifiers used in this Experiment.
    items:
      type: string
      description: "Sample record ID or path."

  reagents:
    type: array
    description: >
      Reagents and materials referenced by ontology ID or local vocab entry.
    items:
      type: object
      required:
        - id
      additionalProperties: false
      properties:
        id:
          type: string
          description: "Ontology or local vocab identifier (e.g., CHEBI:17234)."
        label:
          type: string
          description: "Cached display label to avoid repeated lookups."
        source:
          type: string
          description: "Ontology acronym or 'local' for lab-defined terms."

  instruments:
    type: array
    description: >
      Instrument record identifiers (e.g., flow cytometer, incubator).
    items:
      type: string
      description: "Instrument record ID or path."

  qcResults:
    type: array
    description: "QC result record identifiers associated with this Experiment."
    items:
      type: string
      description: "QC result record ID or path."

  attachments:
    type: array
    description: >
      Attached binary assets via DVC pointer files and hashes.
    items:
      type: object
      required:
        - pointer
        - sha256
      properties:
        pointer:
          type: string
          description: "Path to .dvc pointer file under the data/ tree."
        sha256:
          type: string
          description: "SHA-256 checksum of the underlying binary asset."
          pattern: "^[0-9a-fA-F]{64}$"
        role:
          type: string
          description: "Logical role of the attachment in this Experiment."
          enum: ["raw", "processed", "qc", "report", "other"]
        mediaType:
          type: string
          description: "Optional MIME type (e.g., 'application/pdf', 'image/png')."

  binaryDataFiles:
    type: array
    description: "External data file identifiers (DVC pointers, object storage paths)."
    items:
      type: string

  measurementType:
    $ref: "./ontology-term.schema.yaml"
    description: "Type of measurement (e.g. OBI:0000070)."

  technologyType:
    $ref: "./ontology-term.schema.yaml"
    description: "Analytical technology used (e.g. OBI:0000185)."

  factorValues:
    type: array
    description: "Experimental factors and their values."
    items:
      type: object
      required: [factorName, factorValue]
      properties:
        factorName:
          $ref: "./ontology-term.schema.yaml"
        factorValue:
          type: string
          description: "Concrete value of the factor (e.g. '37°C', '10% FBS')."

  obiType:
    $ref: "./ontology-term.schema.yaml"
    description: "High-level OBI type for this record."

  recipeCard:
    type: object
    description: "Recipe card for reagents and preparation steps."
    properties:
      title:
        type: string
      items:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - reagent
          properties:
            quantity:
              type: string
              description: "Amount (e.g., 10)."
            unit:
              type: string
              description: "Unit for quantity (e.g., mL, mg)."
            reagent:
              $ref: "./ontology-term.schema.yaml"
            notes:
              type: string
              description: "Optional free-form notes."
      steps:
        type: array
        minItems: 1
        items:
          type: string
          description: "Numbered preparation steps."
    required: []
  biology:
    type: object
    properties:
      entities:
        $ref: "./datatypes/biology-entity.schema.yaml#/definitions/BiologyEntityList"
    additionalProperties: false
