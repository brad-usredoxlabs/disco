$schema: "http://json-schema.org/draft-07/schema#"
$title: "Experiment"
type: object

allOf:
  - $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required:
  - title
  - protocolId
  - biologicalEntities
  - projectId
  - shortSlug

properties:
  recordType:
    type: string
    description: "Record discriminator. Should be 'experiment'."
  state:
    type: string
    description: "Workflow state identifier (e.g., draft, approved)."
  recordId:
    type: string
    description: "Stable filesystem identifier generated from naming rules."
  shortSlug:
    type: string
    description: >
      Short identifier (2–4 uppercase alphanumeric chars) used in child Run IDs.
      Example: 'AB01'
    pattern: "^[A-Z0-9]{2,4}$"
    minLength: 2
    maxLength: 4

  projectId:
    type: string
    description: >
      Reference to parent Project/Investigation.
      Should match an existing project record ID.
    # Optional pattern; adjust to your naming convention
    # pattern: "^PRJ-[0-9]{4}(_[A-Z0-9_]+)?$"

  protocolId:
    type: string
    description: >
      Reference to the protocol record used for this experiment.
    # pattern: "^PR-[0-9]{4}(_[A-Z0-9_]+)?$"

  projectShortSlug:
    type: string
    description: "Short slug inherited from the parent project for path generation."

  biologicalEntities:
    type: array
    description: >
      Structured list of biological materials (samples, controls, pathways, etc.) referenced by this experiment.
    items:
      $ref: "./datatypes/biological-entity.schema.yaml"

  reagents:
    $ref: "./datatypes/reagent-list.schema.yaml"
    description: >
      Reagents and materials referenced by ontology ID or local vocab entry.

  instruments:
    type: array
    description: >
      Instrument record identifiers (e.g., flow cytometer, incubator).
    items:
      type: string
      description: "Instrument record ID or path."

  qcResults:
    type: array
    description: "QC result record identifiers associated with this Experiment."
    items:
      type: string
      description: "QC result record ID or path."

  attachments:
    type: array
    description: >
      Attached binary assets via DVC pointer files and hashes.
    items:
      type: object
      required:
        - pointer
        - sha256
      properties:
        pointer:
          type: string
          description: "Path to .dvc pointer file under the data/ tree."
        sha256:
          type: string
          description: "SHA-256 checksum of the underlying binary asset."
          pattern: "^[0-9a-fA-F]{64}$"
        role:
          type: string
          description: "Logical role of the attachment in this Experiment."
          enum: ["raw", "processed", "qc", "report", "other"]
        mediaType:
          type: string
          description: "Optional MIME type (e.g., 'application/pdf', 'image/png')."

  binaryDataFiles:
    type: array
    description: "External data file identifiers (DVC pointers, object storage paths)."
    items:
      type: string

  measurementType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "Type of measurement (e.g. OBI:0000070)."

  technologyType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "Analytical technology used (e.g. OBI:0000185)."

  factorValues:
    type: array
    description: "Experimental factors and their values."
    items:
      type: object
      required: [factorName, factorValue]
      properties:
        factorName:
          $ref: "./datatypes/ontology-term.schema.yaml"
        factorValue:
          type: string
          description: "Concrete value of the factor (e.g. '37°C', '10% FBS')."

  obiType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "High-level OBI type for this record."

  recipeCard:
    $ref: "./datatypes/recipe-card.schema.yaml"
  biology:
    type: object
    properties:
      entities:
        $ref: "./datatypes/biological-entity.schema.yaml#/definitions/BiologyEntityList"
    additionalProperties: false

  assertions:
    type: array
    description: "Embedded assertions associated with this experiment."
    items:
      $ref: "./assertion.schema.yaml"
