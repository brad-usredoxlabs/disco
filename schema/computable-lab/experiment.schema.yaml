$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://computable-lab.com/schema/computable-lab/experiment.schema.yaml"
$title: "Experiment"
type: object

allOf:
  - $ref: "./common.schema.yaml#/$defs/FAIRCommon"

required:
  - title
  - protocolId
  - biologicalEntities
  - studyId
  - shortSlug

properties:
  kind:
    type: string
    description: "Record discriminator. Should be 'experiment'."
    const: "experiment"
  state:
    type: string
    description: "Workflow state identifier (e.g., draft, approved)."
  recordId:
    type: string
    description: "Stable filesystem identifier generated from naming rules."
  shortSlug:
    type: string
    description: >
      Short identifier (2–4 uppercase alphanumeric chars) used in child Run IDs.
      Example: 'AB01'
    pattern: "^[A-Z0-9]{2,4}$"
    minLength: 2
    maxLength: 4

  studyId:
    type: string
    description: >
      Reference to parent Study.
      Should match an existing study record ID.

  protocolId:
    type: string
    description: >
      Reference to the protocol record used for this experiment.
    # pattern: "^PR-[0-9]{4}(_[A-Z0-9_]+)?$"

  studyShortSlug:
    type: string
    description: "Short slug inherited from the parent study for path generation."

BiologyEntry:
  type: object
  description: >
    Study- or context-level biology annotation that wraps a normalized
    BiologicalEntityReference and adds human-readable descriptive context.

  additionalProperties: false
  required:
    - entity

  properties:
    entity:
      $ref: "./biological-entity.schema.yaml"
      description: >
        Reference to the biological entity (taxon, cell line, tissue, pathway,
        etc.) described by this entry.

    description:
      type: string
      description: >
        Optional free-text description providing contextual details about how
        this biological entity is used or interpreted in this study.

  instruments:
    type: array
    description: >
      Instrument record identifiers (e.g., flow cytometer, incubator).
    items:
      type: string
      description: "Instrument record ID or path."

  qcResults:
    type: array
    description: "QC result record identifiers associated with this Experiment."
    items:
      type: string
      description: "QC result record ID or path."

  attachments:
    type: array
    description: >
      Attached binary assets via DVC pointer files and hashes.
    items:
      type: object
      required:
        - pointer
        - sha256
      properties:
        pointer:
          type: string
          description: "Path to .dvc pointer file under the data/ tree."
        sha256:
          type: string
          description: "SHA-256 checksum of the underlying binary asset."
          pattern: "^[0-9a-fA-F]{64}$"
        role:
          type: string
          description: "Logical role of the attachment in this Experiment."
          enum: ["supporting_evidence", "raw_data", "processed_data", "qc", "report", "other"]
        mediaType:
          type: string
          description: "Optional MIME type (e.g., 'application/pdf', 'image/png')."

  measurementType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "Type of measurement (e.g. OBI:0000070)."

  technologyType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "Analytical technology used (e.g. OBI:0000185)."

  factorValues:
    type: array
    description: "Experimental factors and their values."
    items:
      type: object
      required: [factorName, factorValue]
      properties:
        factorName:
          $ref: "./datatypes/ontology-term.schema.yaml"
        factorValue:
          type: string
          description: "Concrete value of the factor (e.g. '37°C', '10% FBS')."

  obiType:
    $ref: "./datatypes/ontology-term.schema.yaml"
    description: "High-level OBI type for this record."

assertions:
  type: array
  description: "Embedded assertions or references to standalone assertion records."
  items:
    oneOf:
      - $ref: "./assertion.schema.yaml"
      - $ref: "./datatypes/assertion-ref.schema.yaml"
