$schema: "http://json-schema.org/draft-07/schema#"
$id: "run.schema.yaml"
title: Run
type: object
description: >
  A Run is an execution session that may include multiple protocol segments,
  acquisitions, and sample operations. Plate state/layout is derived from
  PlateEvents generated by protocol segments.

required:
  - "@id"
  - kind
  - activities

properties:
  "@id":
    type: string
    description: "Global record id for this run (unique)."

  kind:
    type: string
    const: "run"

  label:
    type: string
    description: "Human-readable label."

  project:
    type: string
    description: "Optional Project @id."

  experiment:
    type: string
    description: "Optional parent Experiment @id."

  created_at:
    type: string
    format: date-time

  created_by:
    type: string

  notes:
    type: string

  labware_instances:
    type: array
    description: "Labware instances referenced in this run (ids-only; labels/kinds resolved here)."
    items:
      $ref: "#/definitions/labware_instance"

  source_palette:
    type: array
    description: "Dynamic source palette entries used by the run editor."
    items:
      $ref: "#/definitions/palette_entry"

  # Optional: bindings that apply across the whole run (can be overridden per segment)
  labware_bindings:
    type: object
    description: >
      Deprecated: legacy run-level bindings from labware roles to labware record @ids.
      Prefer labware_instances + source_palette. Protocol segments may override or extend if present.
    additionalProperties:
      type: string

  # Optional: run-level parameter defaults (segments may override)
  parameters:
    type: object
    description: "Optional run-level parameters. Protocol segments may override."
    additionalProperties: true

  activities:
    type: array
    minItems: 1
    description: >
      Ordered timeline of activities. This is the primary structure for a Run.
      Activities may generate PlateEvents, acquisitions (files/metrics), and samples.
    items:
      $ref: "#/definitions/activity"

  attachments:
    type: array
    description: "Optional run-level attachments not tied to a single activity."
    items:
      $ref: "#/definitions/file_ref"

additionalProperties: false

definitions:
  # -------------------------
  # Generic helpers
  # -------------------------

  file_ref:
    type: object
    description: "A pointer to a file/artifact (e.g., DVC, S3, IPFS)."
    required: ["uri"]
    properties:
      label:
        type: string
      uri:
        type: string
        format: uri
      record_ref:
        type: string
        description: "Optional reference to another record that encapsulates this file."
      mime_type:
        type: string
      checksum:
        type: string
    additionalProperties: false

  material_ref:
    description: >
      Reference to a material. Use your repo's canonical MaterialRef datatype if available.
    $ref: "../datatypes/material-ref.schema.yaml"

  labware_ref:
    description: "Reference to labware. Use your repo's canonical LabwareRef datatype."
    $ref: "../datatypes/labware-ref.schema.yaml"

  labware_instance:
    type: object
    description: "Labware instance available to this run."
    required: ["@id", "kind"]
    properties:
      "@id":
        type: string
      kind:
        type: string
      label:
        type: string
      depletion_mode:
        type: string
        description: "How depletion should be handled for this instance (none/volume/count)."
      notes:
        type: string
      layoutRef:
        type: string
        description: "Optional layout/template reference."
      layout_ref:
        type: string
        description: "Deprecated snake_case layout reference."
    additionalProperties: false

  palette_entry:
    type: object
    description: "Entry in the source palette."
    required: ["labwareId"]
    properties:
      labwareId:
        type: string
      label:
        type: string
      archived:
        type: boolean
      layoutRef:
        type: string
        description: "Optional reference to layout/template."
      roleHint:
        type: string
      notes:
        type: string
      # Back-compat: allow legacy snake_case fields, but they are deprecated
      id:
        type: string
        description: "Deprecated duplicate of labwareId."
      labware_id:
        type: string
        description: "Deprecated snake_case labware id."
      layout_ref:
        type: string
        description: "Deprecated snake_case layout ref."
      role_hint:
        type: string
        description: "Deprecated snake_case role hint."
    additionalProperties: false

  plate_event:
    description: "PlateEvent generated during execution."
    $ref: "../datatypes/plate-event.schema.yaml"

  # -------------------------
  # Activity union
  # -------------------------

  activity:
    type: object
    required: ["id", "kind"]
    properties:
      id:
        type: string
        description: "Local identifier unique within this run (e.g., 'seed', 't24_count')."
      kind:
        type: string
        enum: ["protocol_segment", "acquisition", "sample_operation"]
      label:
        type: string
      started_at:
        type: string
        format: date-time
      ended_at:
        type: string
        format: date-time
      notes:
        type: string
    additionalProperties: true
    allOf:
      - oneOf:
          - $ref: "#/definitions/protocol_segment_activity"
          - $ref: "#/definitions/acquisition_activity"
          - $ref: "#/definitions/sample_operation_activity"

  # -------------------------
  # Protocol segment activity
  # -------------------------

  protocol_ref:
    type: object
    description: "Reference to a specific protocol version."
    required: ["@id"]
    properties:
      "@id":
        type: string
        description: "Protocol record @id (specific version)."
      family:
        type: string
      version:
        type: string
      label:
        type: string
    additionalProperties: false

  protocol_segment_activity:
    type: object
    description: >
      A bound execution of a protocol version within a run.
      This is where PlateEvents are generated (transfer/incubate/read/wash/etc.).
    required: ["kind", "protocol", "plate_events"]
    properties:
      kind:
        const: "protocol_segment"

      protocol:
        $ref: "#/definitions/protocol_ref"

      # Bind protocol labware roles to concrete labware record ids
      labware_bindings:
        type: object
        description: >
          Role -> labware @id bindings for this segment.
          If omitted, may fall back to Run.labware_bindings.
        additionalProperties:
          type: string

      # Parameter values used for this segment
      parameters:
        type: object
        description: >
          Concrete parameter values for this segment.
          If omitted, may fall back to Run.parameters.
        additionalProperties: true

      # Concrete plate events produced by this segment
      plate_events:
        type: array
        description: >
          PlateEvents produced by this segment. Plate layout/state is derived by
          replaying these events (across segments) in time order.
        items:
          $ref: "#/definitions/plate_event"

      # Optional: cached derived artifacts (NOT source of truth)
      derived_cache:
        type: object
        description: >
          Optional cached derivations (e.g., rendered plate layout snapshots).
          Must not be treated as source of truth; PlateEvents are canonical.
        properties:
          is_cache:
            type: boolean
            const: true
          derived_from:
            type: string
            description: "Hash or identifier of the event sequence used to generate the cache."
          files:
            type: array
            items:
              $ref: "#/definitions/file_ref"
        additionalProperties: false

      outputs:
        type: object
        description: "Optional summary outputs for this segment."
        properties:
          files:
            type: array
            items:
              $ref: "#/definitions/file_ref"
        additionalProperties: false

    additionalProperties: false

  # -------------------------
  # Acquisition activity
  # -------------------------

  acquisition_slice:
    type: object
    description: "A single acquisition timepoint/slice (e.g., t=-30, t=0, t=5m)."
    required: ["timepoint"]
    properties:
      timepoint:
        type: string
        description: "Relative or named timepoint label (e.g., '-30 min', '0 min', '5 min')."
      acquired_at:
        type: string
        format: date-time
      files:
        type: array
        items:
          $ref: "#/definitions/file_ref"
      metrics:
        type: object
        description: "Optional computed metrics (cell count, confluence, Ct values summary, etc.)."
        additionalProperties: true
      settings:
        type: object
        description: "Optional instrument settings (or overrides)."
        additionalProperties: true
    additionalProperties: false

  acquisition_activity:
    type: object
    description: >
      An acquisition/readout activity. This can represent plate imaging, plate-reader reads,
      qPCR runs, GC-MS metabolomics, etc. It may optionally link back to PlateEvents that
      triggered or contextualize the acquisition.
    required: ["kind", "acquisition_type"]
    properties:
      kind:
        const: "acquisition"

      acquisition_type:
        type: string
        description: >
          High-level acquisition category (implementation agnostic).
          Examples: 'imaging_cell_count', 'plate_reader_fluorescence', 'qpcr', 'gcms_metabolomics'.
        minLength: 1

      instrument:
        type: string
        description: "Instrument @id or label (plate reader, microscope, qPCR machine, GC-MS)."

      # If this acquisition pertains to a plate, reference it:
      labware:
        $ref: "#/definitions/labware_ref"

      mode:
        type: string
        description: "Optional mode (e.g., fluorescence, luminescence, brightfield)."

      channels:
        type: array
        items:
          type: string
        description: "Optional channel list (ROS, MMP, etc.)."

      # Multiple timepoints under one acquisition activity (your T=-30,0,5,15 example)
      acquisitions:
        type: array
        description: "One or more acquisition slices/timepoints."
        items:
          $ref: "#/definitions/acquisition_slice"

      files:
        type: array
        description: "Optional files that apply to the whole acquisition activity."
        items:
          $ref: "#/definitions/file_ref"

      derived_from_plate_events:
        type: array
        description: >
          Optional pointers to the PlateEvents (by local id or record ref) that contextualize this acquisition.
          Use this for linking a readout to the exact event(s) in the plate timeline.
        items:
          type: string

      input_samples:
        type: array
        description: "Optional samples used as inputs (e.g., supernatant sent to GC-MS, cells for qPCR)."
        items:
          type: string

    additionalProperties: false

  # -------------------------
  # Sample operation activity
  # -------------------------

  sample_ref:
    type: object
    description: "Reference to a produced/used sample (not inventory; provenance only)."
    required: ["@id"]
    properties:
      "@id":
        type: string
      label:
        type: string
      record_ref:
        type: string
        description: "Optional reference to the canonical Sample record (@id or path)."
      material:
        $ref: "#/definitions/material_ref"
      volume:
        type: string
      notes:
        type: string
    additionalProperties: false

  sample_operation_activity:
    type: object
    description: >
      A sample-handling operation such as collecting supernatant, splitting cells,
      lysing, aliquoting, freezing, or sending out to an assay. This is provenance,
      not ERP/inventory.
    required: ["kind", "operation"]
    properties:
      kind:
        const: "sample_operation"

      operation:
        type: string
        description: >
          Operation name (e.g., 'collect_supernatant', 'split_cells', 'prep_qpcr', 'send_out_gcms').
        minLength: 1

      from:
        type: object
        description: "Optional source of the material (plate wells, tube, etc.)."
        properties:
          labware:
            $ref: "#/definitions/labware_ref"
          wells:
            type: array
            items:
              type: string
          description:
            type: string
        additionalProperties: false

      produced_samples:
        type: array
        description: "Samples produced by this operation (supernatant, pellets, lysates, aliquots)."
        items:
          $ref: "#/definitions/sample_ref"

      splits:
        type: array
        description: "Optional splitting of one source into multiple samples."
        items:
          type: object
          required: ["sample"]
          properties:
            sample:
              $ref: "#/definitions/sample_ref"
            fraction:
              type: string
              description: "Optional fraction, e.g. '50%' or '2 mL'."
          additionalProperties: false

      destination:
        type: object
        description: "Optional destination context (send-out, freezer, service provider)."
        properties:
          target:
            type: string
            description: "e.g., 'GC-MS core', 'qPCR station', 'freezer -80C'."
          notes:
            type: string
        additionalProperties: false

      files:
        type: array
        description: "Optional supporting files (chain-of-custody, sample sheet, etc.)."
        items:
          $ref: "#/definitions/file_ref"

      # Canonical events emitted by this operation (for replay/lineage)
      plate_events:
        type: array
        items:
          $ref: "#/definitions/plate_event"

    additionalProperties: false
